
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario Diario</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-md rounded-xl p-6">
    <h1 class="text-2xl font-bold mb-6">Formulario de Inventario</h1>

    <div class="mb-6">
      <label for="fecha" class="block font-medium mb-1">Fecha</label>
      <input type="date" id="fecha" readonly class="w-full border rounded p-2 bg-gray-100" />
    </div>

    <div id="acordeones"></div>

    <button id="guardarBtn" class="mt-6 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      Guardar Todo
    </button>

    <p id="respuesta" class="mt-4 text-green-600 font-medium"></p>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwcYJoCcaZ6_igQQxTZf88lzHw7o3V1l2jTucOh1PjxJVHLWWIwMD_nZXPyW_jifIv_/exec";

    const items = [
      { nombre: "Queso campesino", medida: "bloque" },
      { nombre: "Choclo molido", medida: "kg" },
      { nombre: "Leche", medida: "litro" },
      { nombre: "Arepas precocidas", medida: "unidad" }
    ];

    document.addEventListener("DOMContentLoaded", () => {
      // Fecha automática
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("fecha").value = today;

      const contenedor = document.getElementById("acordeones");

      items.forEach((item, i) => {
        const id = i;
        const html = `
        <details class="border rounded mb-4">
          <summary class="cursor-pointer font-semibold px-4 py-2 bg-gray-200">${item.nombre}</summary>
          <div class="p-4 space-y-4 bg-gray-50">
            <input type="hidden" name="item" value="${item.nombre}" />
            <input type="hidden" name="medida" value="${item.medida}" />

            <div>
              <label class="block font-medium">Medida</label>
              <input type="text" value="${item.medida}" disabled class="w-full border rounded p-2 bg-gray-100" />
            </div>

            <div>
              <label class="block font-medium">Stock Inicial Cocina</label>
              <input type="number" name="stockInicial" data-id="${id}" class="w-full border rounded p-2 stock-inicial" />
            </div>

            <div>
              <label class="block font-medium">Usado en Cocina</label>
              <input type="number" name="usadoCocina" data-id="${id}" class="w-full border rounded p-2 usado-cocina" />
            </div>

            <div>
              <label class="block font-medium">Despachado al Punto</label>
              <input type="number" name="despachadoPunto" data-id="${id}" class="w-full border rounded p-2 despachado" />
            </div>

            <div>
              <label class="block font-medium">Stock Final</label>
              <input type="number" name="stockFinal" data-id="${id}" readonly class="w-full border rounded p-2 bg-gray-100 stock-final" />
            </div>

            <div>
              <label class="block font-medium">Sobro</label>
              <input type="number" name="sobro" data-id="${id}" readonly class="w-full border rounded p-2 bg-gray-100 sobro" />
            </div>

            <div>
              <label class="block font-medium">Observaciones</label>
              <textarea name="observaciones" data-id="${id}" class="w-full border rounded p-2"></textarea>
            </div>
          </div>
        </details>
        `;
        contenedor.insertAdjacentHTML("beforeend", html);
      });

      // Calcular automáticamente
      const minimo = 2;
      const calcular = (id) => {
        const ini = parseFloat(document.querySelector(\`.stock-inicial[data-id="\${id}"]\`).value) || 0;
        const usado = parseFloat(document.querySelector(\`.usado-cocina[data-id="\${id}"]\`).value) || 0;
        const desp = parseFloat(document.querySelector(\`.despachado[data-id="\${id}"]\`).value) || 0;
        const final = ini - usado - desp;
        const sobro = final - minimo;

        document.querySelector(\`.stock-final[data-id="\${id}"]\`).value = final;
        document.querySelector(\`.sobro[data-id="\${id}"]\`).value = sobro;
      };

      document.querySelectorAll(".stock-inicial, .usado-cocina, .despachado").forEach(input => {
        input.addEventListener("input", () => {
          const id = input.dataset.id;
          calcular(id);
        });
      });

      // Enviar datos
      document.getElementById("guardarBtn").addEventListener("click", async () => {
        const fecha = document.getElementById("fecha").value;
        const respuesta = document.getElementById("respuesta");
        respuesta.textContent = "";

        const registros = items.map((item, i) => {
          return {
            fecha,
            item: item.nombre,
            medida: item.medida,
            stockInicial: document.querySelector(\`input[name='stockInicial'][data-id="\${i}"]\`).value,
            usadoCocina: document.querySelector(\`input[name='usadoCocina'][data-id="\${i}"]\`).value,
            despachadoPunto: document.querySelector(\`input[name='despachadoPunto'][data-id="\${i}"]\`).value,
            stockFinal: document.querySelector(\`input[name='stockFinal'][data-id="\${i}"]\`).value,
            sobro: document.querySelector(\`input[name='sobro'][data-id="\${i}"]\`).value,
            observaciones: document.querySelector(\`textarea[name='observaciones'][data-id="\${i}"]\`).value
          };
        });

        try {
          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ registros }),
            headers: { "Content-Type": "application/json" }
          });

          if (response.ok) {
            respuesta.textContent = "Inventario enviado correctamente.";
          } else {
            respuesta.textContent = "Error al enviar los datos.";
          }
        } catch (err) {
          console.error(err);
          respuesta.textContent = "Fallo en la conexión con el servidor.";
        }
      });
    });
  </script>
</body>
</html>
